<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>One-to-One Chat | CampusVerse</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="bg-light">

  <div class="container mt-4">
    <h2 class="mb-3">One-to-One Chat</h2>

    <div class="mb-3">
      <input type="text" id="userSearch" class="form-control" placeholder="Search user to chat..." autocomplete="off" />
      <div id="suggestions" class="list-group mt-1"></div>
    </div>

    <div id="chatBox" class="border p-3 rounded bg-white" style="height: 400px; overflow-y: auto;"></div>

    <div class="input-group mt-3">
      <input type="text" id="messageInput" class="form-control" placeholder="Type a message..." />
      <button id="sendBtn" class="btn btn-primary">Send</button>
    </div>
  </div>

  <script>
    const searchInput = document.getElementById("userSearch");
    const suggestions = document.getElementById("suggestions");
    let selectedUserId = null;

    // 🔍 Auto-suggestion search
    searchInput.addEventListener("input", async () => {
      const query = searchInput.value.trim();
      if (!query) {
        suggestions.innerHTML = "";
        return;
      }

      try {
        const res = await fetch("https://campusverse-backend.onrender.com/api/users?search=" + encodeURIComponent(query), {
          method: "GET",
          credentials: "include"
        });

        const users = await res.json();
        suggestions.innerHTML = "";
        users.forEach(user => {
          const item = document.createElement("button");
          item.className = "list-group-item list-group-item-action";
          item.textContent = user.username;
          item.onclick = () => {
            selectedUserId = user._id;
            searchInput.value = user.username;
            suggestions.innerHTML = "";
            loadChat();
          };
          suggestions.appendChild(item);
        });
      } catch (err) {
        console.error("Search failed", err);
      }
    });

    // ⬇️ Load chat history
    async function loadChat() {
      if (!selectedUserId) return;
      try {
        const res = await fetch("https://campusverse-backend.onrender.com/api/chat/one-to-one/" + selectedUserId, {
          method: "GET",
          credentials: "include"
        });
        const data = await res.json();
        const chatBox = document.getElementById("chatBox");
        chatBox.innerHTML = "";

        data.forEach(msg => {
          const msgDiv = document.createElement("div");
          msgDiv.textContent = `${msg.sender.username}: ${msg.text}`;
          chatBox.appendChild(msgDiv);
        });

        chatBox.scrollTop = chatBox.scrollHeight;
      } catch (err) {
        console.error("Chat load failed", err);
      }
    }

    // 📤 Send message
    document.getElementById("sendBtn").addEventListener("click", async () => {
      const text = document.getElementById("messageInput").value.trim();
      if (!text || !selectedUserId) return;

      try {
        await fetch("https://campusverse-backend.onrender.com/api/chat/one-to-one", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify({ receiverId: selectedUserId, text })
        });
        document.getElementById("messageInput").value = "";
        loadChat();
      } catch (err) {
        console.error("Send failed", err);
      }
    });

    // 🔁 Auto-refresh chat every second
    setInterval(() => {
      if (selectedUserId) loadChat();
    }, 1000);
  </script>
</body>
</html>
