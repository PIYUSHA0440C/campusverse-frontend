<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>One-to-One Chat | CampusVerse</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      background-color: #f1f5f9;
    }
    .chat-container {
      display: none;
      height: 80vh;
      margin-top: 2rem;
    }
    .chat-sidebar {
      width: 25%;
      border-right: 1px solid #ddd;
      overflow-y: auto;
      background-color: #fff;
    }
    .chat-main {
      width: 75%;
      padding: 1rem;
      display: flex;
      flex-direction: column;
    }
    .user-item {
      padding: 10px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }
    .user-item:hover, .user-item.active {
      background-color: #e2e8f0;
    }
    .chat-box {
      flex: 1;
      border: 1px solid #ccc;
      padding: 1rem;
      overflow-y: auto;
      background-color: #f8fafc;
    }
    .message {
      margin-bottom: 1rem;
    }
    .message.sent {
      text-align: right;
    }
    .message.received {
      text-align: left;
    }
    .input-group {
      margin-top: 1rem;
    }
    .suggestion-list {
      position: absolute;
      background-color: white;
      z-index: 1000;
      width: 100%;
      border: 1px solid #ccc;
      border-radius: 0.25rem;
      max-height: 200px;
      overflow-y: auto;
    }
    .suggestion-list li {
      padding: 0.5rem;
      cursor: pointer;
    }
    .suggestion-list li:hover {
      background-color: #e2e8f0;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
      <a class="navbar-brand" href="index.html">CampusVerse</a>
      <div class="collapse navbar-collapse justify-content-end">
        <ul class="navbar-nav" id="nav-user-area"></ul>
      </div>
    </div>
  </nav>

  <div class="container chat-container" id="chatContainer">
    <div class="chat-sidebar p-3">
      <div class="mb-3 search-box position-relative">
        <input type="text" class="form-control" id="userSearch" placeholder="Search users...">
        <ul class="list-group suggestion-list" id="suggestions" style="display: none;"></ul>
      </div>
      <div id="contactList"></div>
    </div>
    <div class="chat-main">
      <h5 id="chatHeader" class="mb-3 text-muted">Select a contact to chat</h5>
      <div class="chat-box mb-3" id="chatMessages"></div>
      <div class="input-group">
        <input type="text" class="form-control" id="chatInput" placeholder="Type your message...">
        <button class="btn btn-primary" id="sendBtn">Send</button>
      </div>
    </div>
  </div>

  <!-- SCRIPT SECTION BELOW -->
  <script>
    const API = "https://campusverse-backend.onrender.com/api";
    let username, contacts = [], selectedUser = null;
    let isTyping = false, isSearching = false, poll;
    let highlightedIndex = -1;

    async function init() {
      try {
        const res = await fetch(`${API}/auth/user`, { credentials: 'include' });
        if (!res.ok) throw 0;
        const user = await res.json();
        username = user.username;
        document.getElementById("nav-user-area").innerHTML = `
          <li class="nav-item"><a class="nav-link" href="profile.html">ðŸ‘¤ ${username}</a></li>
          <li class="nav-item"><a class="nav-link text-danger" href="#" onclick="logout()">Logout</a></li>`;
        document.getElementById("chatContainer").style.display = "flex";
        await loadContacts();
      } catch { window.location.href = "login.html"; }
    }

    function logout() {
      fetch(`${API}/auth/logout`, { credentials: 'include' })
        .then(() => window.location.href = "login.html");
    }

    async function loadContacts() {
      try {
        const res = await fetch(`${API}/chat/one-to-one/contacts`, { credentials: 'include' });
        contacts = res.ok ? await res.json() : [];
      } catch { contacts = []; }
      renderContacts();
    }

    function renderContacts() {
      const list = document.getElementById("contactList");
      list.innerHTML = contacts.length ? "" : `<p class="text-muted text-center mt-3">No contacts yet. Search above to add!</p>`;
      contacts.forEach(c => {
        const div = document.createElement("div");
        div.className = "user-item" + (c.username === selectedUser ? " active" : "");
        div.textContent = c.username;
        div.onclick = () => selectUser(c.username);
        list.appendChild(div);
      });
    }

    let searchTimer;
    document.getElementById("userSearch").addEventListener("input", () => {
      clearTimeout(searchTimer);
      isSearching = true;
      searchTimer = setTimeout(() => {
        suggestUsers();
        isSearching = false;
      }, 300);
    });

    document.getElementById("userSearch").addEventListener("keydown", (e) => {
      const suggestions = document.getElementById("suggestions");
      const items = suggestions.querySelectorAll("li");
      if (!items.length || suggestions.style.display === "none") return;

      if (e.key === "ArrowDown") {
        e.preventDefault();
        highlightedIndex = (highlightedIndex + 1) % items.length;
        updateHighlight(items);
      } else if (e.key === "ArrowUp") {
        e.preventDefault();
        highlightedIndex = (highlightedIndex - 1 + items.length) % items.length;
        updateHighlight(items);
      } else if (e.key === "Enter" && highlightedIndex >= 0) {
        e.preventDefault();
        items[highlightedIndex].click();
      }
    });

    function updateHighlight(items) {
      items.forEach((item, index) => {
        item.style.backgroundColor = index === highlightedIndex ? "#475569" : "";
      });
    }

    async function suggestUsers() {
      const query = document.getElementById("userSearch").value.trim();
      const ul = document.getElementById("suggestions");
      ul.innerHTML = "";
      highlightedIndex = -1;
      if (!query) return ul.style.display = 'none';
      ul.style.display = 'block';

      try {
        const res = await fetch(`${API}/users?search=${encodeURIComponent(query)}`, { credentials: 'include' });
        if (!res.ok) return ul.innerHTML = `<li class="text-danger">Error fetching users</li>`;
        const users = await res.json();
        const filtered = users.filter(u => u.username !== username && !contacts.some(c => c.username === u.username)).slice(0, 5);
        if (filtered.length === 0) return ul.innerHTML = `<li class="text-muted">No matches found</li>`;
        filtered.forEach(u => {
          const li = document.createElement("li");
          li.textContent = u.username;
          li.onclick = async () => {
            pausePolling();
            const res = await fetch(`${API}/chat/one-to-one/contacts`, {
              method: "POST", credentials: "include",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ contact: u.username })
            });

            if (res.ok) {
              if (!contacts.some(c => c.username === u.username)) {
                contacts.push({ username: u.username });
                renderContacts();
              }
              selectUser(u.username);
              document.getElementById("userSearch").value = "";
              ul.style.display = 'none';
            } else {
              alert("Failed to add contact.");
            }

            resumePolling();
          };
          ul.appendChild(li);
        });
      } catch (err) {
        console.error("User fetch error:", err);
        ul.innerHTML = `<li class="text-danger">Error fetching users</li>`;
      }
    }

    document.addEventListener('click', (e) => {
      if (!document.querySelector('.search-box').contains(e.target)) {
        document.getElementById('suggestions').style.display = 'none';
      }
    });

    function selectUser(name) {
      selectedUser = name;
      document.getElementById("chatHeader").textContent = `Chatting with: ${name}`;
      renderContacts();
      document.getElementById("chatMessages").innerHTML = `<p class="text-center text-muted">Loading messages...</p>`;
      clearInterval(poll);
      startPolling();
    }

    function startPolling() {
      fetchAndRender();
      poll = setInterval(fetchAndRender, 3000);
    }
    function pausePolling() { clearInterval(poll); }
    function resumePolling() {
      if (selectedUser && !isTyping && !isSearching) startPolling();
    }

    async function fetchAndRender() {
      if (!selectedUser || isTyping || isSearching) return;
      try {
        const res = await fetch(`${API}/chat/one-to-one/${encodeURIComponent(selectedUser)}`, { credentials: 'include' });
        if (!res.ok) return document.getElementById("chatMessages").innerHTML = `<p class="text-center text-danger">Failed to load messages.</p>`;
        const msgs = await res.json();
        const box = document.getElementById("chatMessages");
        box.innerHTML = msgs.map(m => `
          <div class="message ${m.sender.username === username ? "sent" : "received"}">
            ${m.text}
            <div class="meta text-end text-muted" style="font-size: 0.75rem;">
              ${new Date(m.createdAt).toLocaleTimeString()}
            </div>
          </div>`).join("");
        box.scrollTop = box.scrollHeight;
      } catch (err) {
        console.error("Fetch error:", err);
      }
    }

    async function sendMessage() {
      const input = document.getElementById("chatInput");
      const text = input.value.trim();
      if (!text || !selectedUser) return;
      try {
        const res = await fetch(`${API}/chat/one-to-one/${encodeURIComponent(selectedUser)}`, {
          method: "POST", credentials: "include",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text })
        });
        if (res.ok) {
          input.value = "";
          isTyping = false;
          fetchAndRender();
        } else {
          alert("Failed to send message.");
        }
      } catch {
        alert("Error sending message.");
      }
    }

    const inp = document.getElementById("chatInput");
    inp.addEventListener("keydown", e => {
      if (e.key === "Enter") {
        e.preventDefault();
        sendMessage();
      }
    });
    inp.addEventListener("focus", () => { isTyping = true; pausePolling(); });
    inp.addEventListener("blur", () => { isTyping = false; resumePolling(); });
    inp.addEventListener("input", () => {
      if (!inp.value.trim()) {
        isTyping = false;
        fetchAndRender();
      }
    });

    document.getElementById("sendBtn").addEventListener("click", sendMessage);
    window.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
